---
Keywords: bashCMS2
Copyright: (C) 2019 青竹
---

# bashCMS2にコメント機能を付加しました

当サイトを構成するシステム「bashCMS2」は、大変軽量にして強力なCMSです。

そのままでも快適なブログライフ(？)を楽しめますが、ブログに付き物のコメント機能はついていません。コメント機能は、自分以外の不特定多数の読者さんに書いてもらうものであり、時には悪意ある招かれざる客やスパムbotの標的にされるという性格上、実装するかしないかを慎重に決定しないといけません。

## コメント機能があるメリット

読者の方からの意見や情報を直接頂戴できるという利点があります。実際、WordPressで運営している旧サイトのブログには、コメントを寄せてくださる方がいらっしゃいます。

## コメント機能のデメリット・懸念点

先に述べた通り、自分以外の人、時にはプログラムが書いていくものであるため、場合によっては他の人に悪影響を与えるスクリプトを書き込まれたりするおそれがあります。また、スパムコメントを表示することも避けねばなりません。

以上のことを検討した結果、試験的にコメント機能を実装し、コメント書き込みとコメント表示の間に、管理者である自分の手を介在させる、いわゆる「承認」作業を挟むことにしました。また、悪意あるスクリプトの書き込みで、自分や訪問客のシステムに被害が出ることを防ぐため、特殊記号の無害化機能も組み込むことに決めました。もっとも、無害化機能の組み込みはセキュリティ上当然要請される事項ですが。

## 追加システムの概要

bashCMS2のシステムに対して、コメント投稿をAjaxで処理するJavaScriptと、コメント登録処理を担うCGIプログラムを追加します。また、メインページを描画するindex.cgiに、コメントを表示するためのYAMLメタデータ追加機能を実装します。さらに、テンプレートページにコメント投稿フォームを追加します。

コメントをファイルに記録する際、単純に記録処理をすると、書き込みの競合が発生した場合にファイルが破損するおそれがあります。それを防ぐ排他制御を実施するために、秘密結社シェルショッカー日本支部にてパブリックドメインで公開されている、排他制御シェルスクリプトコマンドを導入します。
※排他制御はPerlやRubyでスクリプトを組む手もありましたが、先人達の智慧をありがたく活用するのが早道であると考えました。

また、CGIに渡されるデータを安全かつ確実に処理するために、Open usp Tukubaiのコマンドを利用しております。

投稿されたコメントは、承認待ちのファイルにYAML形式で記録されます。コメントを承認済みとし、ページに表示するためには、承認済みファイルにコメントデータを転記する形で行います。今のところこの作業は手動ですが、スクリプトを組むことも将来的に考えています。

## 追加システムの実装

今回自力で追加実装したコードは、のべ100行となりました。実装に用いた言語はシェルスクリプト (bash) です。実装の詳細は、GitHubに公開しているコードをご覧ください。
